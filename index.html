<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Biofeedback Voice Tuner</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #111;
            color: #ddd;
            text-align: center;
            margin: 0;
            padding: 20px;
        }
        h1 {
            margin-top: 20px;
        }
        button {
            font-size: 1em;
            padding: 10px 20px;
            cursor: pointer;
            margin: 10px;
            border: none;
            border-radius: 5px;
        }
        button:disabled {
            opacity: 0.5;
        }
        #start { background-color: #0a84ff; color: white; }
        #stop { background-color: #ff375f; color: white; }

        select {
            font-size: 1em;
            padding: 8px;
            border-radius: 5px;
            background-color: #222;
            color: #ddd;
            border: none;
        }
        .display {
            margin-top: 30px;
            padding: 20px;
            background-color: #222;
            border-radius: 8px;
            display: inline-block;
            width: 80%;
            max-width: 500px;
        }
        .pitch { font-size: 3em; }
        .frequency { font-size: 2em; color: #0a84ff; }
        .indicator { font-size: 2em; margin-top: 20px; }
        label { margin-top: 10px; display: block; }
        select {
            margin-top: 10px;
            font-size: 1em;
            padding: 8px;
            border-radius: 5px;
            background-color: #333;
            color: #ddd;
            border: none;
        }
    </style>
</head>
<body>
    <h1>Vocal Biofeedback Tuner</h1>

    <button id="start">ðŸŽ¤ Start Analysis</button>
    <button id="stop" disabled>ðŸ›‘ Stop</button>

    <label for="target">Select Target Frequency (Hz)</label>
    <select id="target">
        <option value="120">120 Hz</option>
        <option value="150">150 Hz</option>
        <option value="200">200 Hz</option>
        <option value="250">250 Hz</option>
        <option value="261.63">261.63 Hz (C4)</option>
        <option value="440" selected>440 Hz (A4)</option>
        <option value="500">500 Hz</option>
    </select>

    <div class="display">
        <div class="pitch" id="note">â€”</div>
        <div class="frequency" id="hz">0 Hz</div>
        <div class="indicator" id="indicator">ðŸŽ¯ Awaiting Input</div>
    </div>

    <script>
        let audioCtx, analyser, microphone, dataArray, rafID;

        const noteElem = document.getElementById('note');
        const hzElem = document.getElementById('hz');
        const indicator = document.getElementById('indicator');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const targetSelect = document.getElementById('target');

        startBtn.onclick = async () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioCtx.createAnalyser();
            microphone = audioCtx.createMediaStreamSource(stream);
            microphone.connect(analyser);

            analyser.fftSize = 2048;
            dataArray = new Float32Array(analyser.fftSize);

            updatePitch();

            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        stopBtn.onclick = () => {
            if (microphone) microphone.disconnect();
            if (rafID) cancelAnimationFrame(rafID);
            noteElem.textContent = 'â€”';
            hzElem.textContent = '0 Hz';
            indicator.textContent = 'ðŸŽ¯ Stopped';
            indicator.style.color = '#ddd';

            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        function updatePitch() {
            analyser.getFloatTimeDomainData(dataArray);
            const frequency = autoCorrelate(dataArray, audioCtx.sampleRate);

            if (frequency > -1 && frequency < 2000) {
                hzElem.textContent = frequency.toFixed(2) + ' Hz';
                noteElem.textContent = getNoteFromFrequency(frequency);
                checkTuning(frequency, parseFloat(targetSelect.value));
            }

            rafID = requestAnimationFrame(updatePitch);
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let corr = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) {
                for (let j = 0; j < SIZE - i; j++) {
                    corr[i] += buf[j] * buf[j + i];
                }
            }
            let d = 0;
            while (corr[d] > corr[d + 1]) d++;
            let maxPos = d;
            for (let i = d; i < SIZE; i++) if (corr[i] > corr[maxPos]) maxPos = i;

            return sampleRate / maxPos;
        }

        function getNoteFromFrequency(frequency) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const noteIndex = Math.round(noteNum) + 69;
            return notes[noteIndex % 12];
        }

        function checkTuning(frequency, target) {
            const diff = frequency - target;
            if (Math.abs(diff) < 1) {
                indicator.textContent = 'âœ… Optimal';
                indicator.style.color = '#0f0';
            } else if (diff < 0) {
                indicator.textContent = 'â¬†ï¸ Too Low (Flat)';
                indicator.style.color = '#0af';
            } else {
                indicator.textContent = 'â¬‡ï¸ Too High';
                indicator.style.color = '#f55';
            }
        }
    </script>
</body>
</html>
