<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Tuner App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 40px;
        }
        .pitch {
            font-size: 3em;
            margin-top: 20px;
        }
        .frequency {
            font-size: 1.5em;
            color: #555;
        }
        button {
            font-size: 1em;
            padding: 8px 16px;
            cursor: pointer;
            margin: 10px;
        }
        select {
            font-size: 1em;
            padding: 5px;
        }
        .indicator {
            font-size: 2em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>🎤 Voice Tuner</h1>

    <button id="start">🎤 Start Tuning</button>
    <button id="stop" disabled>🛑 Stop Tuning</button>

    <div>
        Target Note:
        <select id="target">
            <option value="261.63">C4 (Middle C)</option>
            <option value="293.66">D4</option>
            <option value="329.63">E4</option>
            <option value="349.23">F4</option>
            <option value="392.00">G4</option>
            <option value="440.00" selected>A4 (Standard Tuning)</option>
            <option value="493.88">B4</option>
            <option value="523.25">C5</option>
        </select>
    </div>

    <div class="pitch" id="note">—</div>
    <div class="frequency" id="hz">0 Hz</div>
    <div class="indicator" id="indicator">🎯</div>

    <script>
        let audioCtx, analyser, microphone, dataArray, rafID;

        const noteElem = document.getElementById('note');
        const hzElem = document.getElementById('hz');
        const indicator = document.getElementById('indicator');
        const startBtn = document.getElementById('start');
        const stopBtn = document.getElementById('stop');
        const targetSelect = document.getElementById('target');

        startBtn.onclick = async () => {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioCtx.createAnalyser();
            microphone = audioCtx.createMediaStreamSource(stream);
            microphone.connect(analyser);

            analyser.fftSize = 2048;
            dataArray = new Float32Array(analyser.fftSize);

            updatePitch();

            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        stopBtn.onclick = () => {
            if (microphone) microphone.disconnect();
            if (rafID) cancelAnimationFrame(rafID);
            if (audioCtx) audioCtx.close();

            noteElem.textContent = '—';
            hzElem.textContent = '0 Hz';
            indicator.textContent = '🎯';
            indicator.style.color = 'black';

            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        function updatePitch() {
            analyser.getFloatTimeDomainData(dataArray);
            const frequency = autoCorrelate(dataArray, audioCtx.sampleRate);

            if (frequency > -1 && frequency < 2000) {
                hzElem.textContent = frequency.toFixed(2) + ' Hz';
                noteElem.textContent = getNoteFromFrequency(frequency);
                checkTuning(frequency, parseFloat(targetSelect.value));
            }

            rafID = requestAnimationFrame(updatePitch);
        }

        function autoCorrelate(buf, sampleRate) {
            let SIZE = buf.length;
            let rms = 0;
            for (let i = 0; i < SIZE; i++) rms += buf[i] * buf[i];
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let corr = new Array(SIZE).fill(0);
            for (let i = 0; i < SIZE; i++) {
                for (let j = 0; j < SIZE - i; j++) {
                    corr[i] += buf[j] * buf[j + i];
                }
            }
            let d = 0;
            while (corr[d] > corr[d + 1]) d++;
            let maxPos = d;
            for (let i = d; i < SIZE; i++) if (corr[i] > corr[maxPos]) maxPos = i;

            return sampleRate / maxPos;
        }

        function getNoteFromFrequency(frequency) {
            const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const noteNum = 12 * (Math.log(frequency / 440) / Math.log(2));
            const noteIndex = Math.round(noteNum) + 69;
            return notes[noteIndex % 12];
        }

        function checkTuning(frequency, target) {
            let diff = frequency - target;
            if (Math.abs(diff) < 1) {
                indicator.textContent = '✅ In Tune';
                indicator.style.color = 'green';
            } else if (frequency < target) {
                indicator.textContent = '⬆️ Flat';
                indicator.style.color = 'blue';
            } else {
                indicator.textContent = '⬇️ Sharp';
                indicator.style.color = 'red';
            }
        }
    </script>
</body>
</html>
